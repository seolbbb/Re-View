# 캡처 중복 제거 최적화 비교 문서

---

## 1. 개요

강의 영상에서 발표자가 슬라이드를 앞/뒤로 오가며 설명할 때 발생하는 **중복 슬라이드 저장 문제**를 해결하는 최적화입니다.
최신 버전에서는 `time_ranges` 구조를 통해 VLM 호출을 최소화하고, 내부적인 `info_score` 계산을 통해 가장 선명한 이미지를 대표로 선택합니다.

---

## 2. manifest.json 구조 비교

````carousel
**이전 버전** - 단일 시간 범위 (비효율적)

```json
{
  "file_name": "sample4_002_10604_85002.jpg",
  "start_ms": 10604,
  "end_ms": 85002,
  "id": "cap_002"
}
```

<!-- slide -->

**새 버전** - 다중 시간 범위 통합 (VLM 최적화)

```json
{
  "file_name": "sample4_002.jpg",
  "time_ranges": [
    {"start_ms": 10604, "end_ms": 21167},
    {"start_ms": 21167, "end_ms": 85002},
    {"start_ms": 90972, "end_ms": 129090},
    {"start_ms": 159860, "end_ms": 208081}
  ],
  "id": "cap_002"
}
```
````

> [!NOTE]
> `info_score`는 내부적으로 대표 이미지 선정 시에만 사용되며, 최종 `manifest.json` 산출물에는 포함되지 않아 파일 크기를 최적화합니다.

---

## 3. 수치 비교 (sample4 기준)

| 항목 | 이전 (Naive) | 최적화 버전 | 개선율 |
|------|------|--------|--------|
| **저장 이미지 수** | 11개 | 5개 | **-55%** |
| **VLM API 호출** | 11회 | 5회 | **-55%** |
| **중복 슬라이드** | 6개 | 0개 | **-100%** |

---

## 4. 타임라인 가시화

### [Before] 11개 이미지 순차 저장

```text
0ms                                                           376,333ms
├──────────────────────────────────────────────────────────────────────┤
│ [001]  [002 ──────────────]  [003] [004][005 ────] [006] [007 ──]    │
│ 41~    10,604~85,002         85k~  91k~ 94k~       129k~ 132k~       │
└──────────────────────────────────────────────────────────────────────┘
```

### [After] 5개 고유 이미지 통합 (`time_ranges`)

```text
0ms                                                           376,333ms
├──────────────────────────────────────────────────────────────────────┤
│ 🟢 001.jpg ─ [41 ~ 10,604]                                           │
│ 🔵 002.jpg (슬라이드A) ─ [10k~85k], [90k~129k], [159k~208k]           │
│ 🟡 004.jpg (슬라이드B) ─ [85k~90k], [132k~159k], [208k~226k]          │
│ 🟠 006.jpg (슬라이드C) ─ [129k~132k], [226k~376k]                     │
│ 🔴 011.jpg ─ [376,166 ~ 376,333]                                     │
└──────────────────────────────────────────────────────────────────────┘
```

---

## 5. 핵심 알고리즘: Global Deduplication

### 중복 판정 로직

1. **pHash (Perceptual Hash)**: DCT 기반 64비트 해시로 O(1) 고속 후보 탐색 (임계값 15).
2. **ORB Feature Follow-up**: pHash 후보군 및 최근 5개 이미지에 대해 특징점 매칭 수행.
3. **대표 이미지 교체**: 중복 발견 시 기존 이미지보다 `info_score`가 높으면 파일을 교체하여 최상의 품질 유지.

### info_score (내부 지표)

```python
# 선명도/정보량 기반 대표 이미지 선정 기준
info_score = 0.6 × (ORB 특징점 수 / 500) + 0.4 × 엣지 밀도
```

---

## 6. 주요 개선 사항 (Feature Updates)

### ✅ 첫 번째 슬라이드 미병합 이슈 해결

- **문제**: 첫 프레임은 비교 대상이 없어 늘 고유 슬라이드로 취급됨.
- **해결**: 모든 추출 프로세스 완료 후 `_merge_first_slide_if_duplicate()`를 호출하여 나중에 등장한 동일 슬라이드와 사후 병합(Post-merge) 수행.

### ✅ Fragmented Ranges 병합

- 캡처 간격이 200ms 이하인 미세한 시간 경계는 분석 효율을 위해 자동으로 하나의 `time_range`로 병합 처리됩니다.

---

## 7. 실행 로그 (예시)

```text
[Capture] Processing: sample4
  [Dedup] sample4_002 + 01:30~02:09 (90972~129090ms)
  [Dedup] sample4_004 + 02:12~02:39 (132305~159860ms)
  [Dedup] sample4_002 + 02:39~03:28 (159860~208081ms) (replaced)
  [Dedup] First slide merged to #2 (post-process)
  [Dedup] Final: 5 unique slides (history: 5)
```

*(replaced) 로그는 현재 프레임이 기존 저장된 이미지보다 선명하여 대표 이미지가 교체되었음을 의미합니다.*
