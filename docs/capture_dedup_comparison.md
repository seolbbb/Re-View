# 캡처 중복 제거 최적화 비교 문서

---

## 1. 개요

강의 영상에서 발표자가 슬라이드를 앞/뒤로 오가며 설명할 때 발생하는 **중복 슬라이드 저장 문제**를 해결하는 최적화입니다.

---

## 2. manifest.json 구조 비교

````carousel
**이전 버전** - 단일 시간 범위
```json
{
  "file_name": "sample4_002_10604_85002.jpg",
  "start_ms": 10604,
  "end_ms": 85002,
  "id": "cap_002"
}
```
<!-- slide -->
**새 버전** - 다중 시간 범위 + 정보량 점수
```json
{
  "file_name": "sample4_002.jpg",
  "time_ranges": [
    {"start_ms": 10604, "end_ms": 21167},
    {"start_ms": 21167, "end_ms": 85002},
    {"start_ms": 90972, "end_ms": 129090},
    {"start_ms": 159860, "end_ms": 208081}
  ],
  "info_score": 0.62,
  "id": "cap_002"
}
```
````

---

## 3. 수치 비교

| 항목 | 이전 | 새 버전 | 개선율 |
|------|------|--------|--------|
| 저장 이미지 수 | 11개 | 5개 | **-55%** |
| VLM API 호출 | 11회 | 5회 | **-55%** |
| 중복 슬라이드 | 6개 | 0개 | **-100%** |

---

## 4. 타임라인 비교 (ms 기준)

### 이전 버전 - 11개 이미지

```
0ms                                                           376,333ms
├──────────────────────────────────────────────────────────────────────┤
│ [001]  [002 ──────────────]  [003] [004][005 ────] [006] [007 ──]    │
│ 41~    10,604~85,002         85k~  91k~ 94k~       129k~ 132k~       │
│ 10,604                       91k   94k  129k       132k  160k        │
├──────────────────────────────────────────────────────────────────────┤
│ [008 ────────] [009 ──] [010 ────────────────────────────] [011]     │
│ 159,860~       208k~    226,910~376,166                    376k~     │
│ 208,081        227k                                        376k      │
└──────────────────────────────────────────────────────────────────────┘
```

### 새 버전 - 5개 이미지 (time_ranges 통합)

```
0ms                                                           376,333ms
├──────────────────────────────────────────────────────────────────────┤
│ 🟢 001.jpg ─ [41 ~ 10,604]                                           │
│                                                                      │
│ 🔵 002.jpg (슬라이드A) ─┬─ [10,604 ~ 21,167]                          │
│                        ├─ [21,167 ~ 85,002]                          │
│                        ├─ [90,972 ~ 129,090]                         │
│                        └─ [159,860 ~ 208,081]                        │
│                                                                      │
│ 🟡 004.jpg (슬라이드B) ─┬─ [85,002 ~ 90,972]                          │
│                        ├─ [132,305 ~ 159,860]                        │
│                        └─ [208,081 ~ 226,910]                        │
│                                                                      │
│ 🟠 006.jpg (슬라이드C) ─┬─ [129,090 ~ 132,305]                        │
│                        └─ [226,910 ~ 376,166]                        │
│                                                                      │
│ 🔴 011.jpg ─ [376,166 ~ 376,333]                                     │
└──────────────────────────────────────────────────────────────────────┘
```

---

## 5. 핵심 알고리즘

### 중복 제거 파이프라인

```
┌─────────────────────────────────────────────────────────────┐
│ 1. 전환 감지 → 슬라이드 후보 추출                              │
│                                                              │
│ 2. pHash 계산 (DCT 기반 64비트 해시)                          │
│    └─ 해밍 거리 ≤ 10 → 유사 후보                              │
│                                                              │
│ 3. ORB 상세 비교 (최근 5장 + pHash 후보)                      │
│    ├─ 유사도 ≥ 0.5 → 중복 판정                                │
│    │   └─ time_ranges에 시간 추가                            │
│    │   └─ info_score 비교 → 대표 이미지 교체 여부              │
│    └─ 유사도 < 0.5 → 새 슬라이드 저장                         │
│                                                              │
│ 4. 최종 출력: file_name + time_ranges[] + info_score         │
└─────────────────────────────────────────────────────────────┘
```

### info_score 계산 로직

```python
info_score = 0.6 × ORB 특징점 정규화 + 0.4 × 엣지 밀도
```

| 요소 | 계산 방법 | 의미 |
|------|----------|------|
| **ORB 특징점 정규화** | `min(특징점 수 / 500, 1.0)` | 이미지 내 텍스트/도형 복잡도 |
| **엣지 밀도** | `Canny 에지 픽셀 수 / 전체 픽셀 수` | 경계선 풍부도 |

**목적**: 중복 슬라이드 중 **정보량이 더 높은 이미지**를 대표로 선택

---

## 6. 실행 결과 로그

```
[Capture] Processing: sample4
  [Dedup] Slide 3 merged to #2 (ranges: 2)   ← 슬라이드 A 재등장
  [Dedup] Slide 5 merged to #2 (ranges: 3)   ← 슬라이드 A 재등장
  [Dedup] Slide 7 merged to #4 (ranges: 2)   ← 슬라이드 B 재등장
  [Dedup] Slide 8 merged to #2 (ranges: 4)   ← 슬라이드 A 재등장
  [Dedup] Slide 9 merged to #4 (ranges: 3)   ← 슬라이드 B 재등장
  [Dedup] Slide 10 merged to #6 (ranges: 2)  ← 슬라이드 C 재등장
  [Dedup] Final: 5 unique slides (history: 5)
[Capture] Completed: 5 slides in 13.30s
```

---

## 7. 알려진 이슈

### 첫 번째 슬라이드 미병합 문제

**현상**: 육안으로 [001, 002, 004, 008]이 동일 슬라이드로 보이지만, 001이 별도로 저장됨

**원인**: Delayed Save 구조에서 첫 슬라이드 저장 시 비교 대상(history)이 비어있어 무조건 새로 저장

**해결 방안 (검토 중)**:
- Option A: 모든 저장 완료 후 후처리로 통합
- Option B: 첫 슬라이드를 나중에 재비교
- Option C: 임계값 조정
